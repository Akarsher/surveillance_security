<!DOCTYPE html>
<html>
<head>
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="/static/admin.css">
  
</head>
<body>

<hr>

<div style="display:flex; justify-content: space-between; align-items: center;">
  <h2>Current Employees</h2>
  <button class="btn" onclick="openStream()">Live Stream</button>
</div>
<table id="personsTable">
  <tr>
    <th>Name</th><th>Role</th><th>Image</th><th>Actions</th>
  </tr>
</table>

<hr>
<h2>Add Employee</h2>
<form id="addForm" style="margin-bottom:12px;">
  <input name="name" placeholder="Name" required>
  <select name="role">
    <option value="authorized">Authorized</option>
    <option value="restricted">Restricted</option>
  </select>
  <input type="file" name="image" required>
  <button class="btn">Add</button>
</form>
<p id="addMsg"></p>

<hr>

<h2>Event Logs</h2>

<div style="display:flex; gap:8px; align-items:center; margin:8px 0;">
  <label>From <input type="date" id="startDate"></label>
  <label>To <input type="date" id="endDate"></label>
  <button class="btn" onclick="applyFilter()">Apply Filter</button>
  <button class="btn" onclick="exportCSV()">Export CSV</button>
</div>

<!-- Live alert banner -->
<div id="alertBanner" class="alert-banner" style="display:none;">
  <strong>SECURITY ALERT:</strong> <span id="alertText"></span>
</div>

<table id="eventsTable">
  <tr>
    <th>Time</th><th>Reason</th>
    <th>Auth</th><th>Restr</th><th>Unk</th><th>Snapshot</th>
  </tr>
</table>

<hr>

<div id="toast" class="toast" style="display:none;"></div>

<script>
function showToast(msg, ok=true) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.background = ok ? 'rgba(16,185,129,.15)' : 'rgba(239,68,68,.15)';
  t.style.border = ok ? '1px solid #10b981' : '1px solid #ef4444';
  t.style.display = 'block';
  setTimeout(() => t.style.display = 'none', 2500);
}

async function loadPersons() {
  const res = await fetch("/admin/persons");
  const persons = await res.json();
  const table = document.getElementById("personsTable");
  table.innerHTML = `
    <tr>
      <th>Name</th><th>Role</th><th>Image</th><th>Actions</th>
    </tr>`;
  persons.forEach(p => {
    const imgHref = p.image_path ? ('/' + p.image_path.replace(/^[\/]*/, '').replace(/\\/g,'/')) : '#';
    table.innerHTML += `
      <tr>
        <td>
          <input value="${p.name}" id="name_${p.id}" style="width:140px;">
        </td>
        <td>
          <select id="role_${p.id}">
            <option value="authorized" ${p.role==='authorized'?'selected':''}>Authorized</option>
            <option value="restricted" ${p.role==='restricted'?'selected':''}>Restricted</option>
          </select>
        </td>
        <td>
          ${p.image_path ? `<a href="${imgHref}" target="_blank">View</a>` : '-'}
          <label class="btn" style="margin-left:8px; position:relative;">
            Change Image
            <input type="file" accept="image/*" style="position:absolute; inset:0; opacity:0;"
              onchange="updateImageById(${p.id}, document.getElementById('role_${p.id}').value, this.files[0])">
          </label>
        </td>
        <td style="display:flex; gap:8px; align-items:center;">
          <button class="btn" onclick="editPerson(${p.id})">Save</button>
          <button class="btn" style="background:#ef4444;" onclick="deletePersonById(${p.id})">Delete</button>
        </td>
      </tr>`;
  });
}

document.getElementById("addForm").onsubmit = async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const res = await fetch("/admin/add_person", { method: "POST", body: formData });
  const data = await res.json();
  showToast(data.message || "Added", res.ok);
  loadPersons();
};

async function editPerson(id) {
  const name = document.getElementById(`name_${id}`).value;
  const role = document.getElementById(`role_${id}`).value;
  const form = new FormData();
  form.append("id", id);
  form.append("name", name);
  form.append("role", role);
  const ok = confirm(`Save changes for ${name}?`);
  if (!ok) return;
  const res = await fetch("/admin/edit_person", { method: "POST", body: form });
  const data = await res.json();
  showToast(data.message || "Updated", res.ok);
  loadPersons();
}

async function updateImageById(id, role, file) {
  if (!file) return;
  const ok = confirm("Replace image?");
  if (!ok) return;
  const form = new FormData();
  form.append("id", id);
  form.append("role", role);
  form.append("image", file);
  const res = await fetch("/admin/update_image_by_id", { method: "POST", body: form });
  const data = await res.json();
  showToast(data.message || "Image updated", res.ok);
  loadPersons();
}

async function deletePersonById(id) {
  const ok = confirm("Delete this person?");
  if (!ok) return;
  const form = new FormData();
  form.append("id", id);
  const res = await fetch("/admin/delete_person_by_id", { method: "POST", body: form });
  const data = await res.json();
  showToast(data.message || "Deleted", res.ok);
  loadPersons();
}

// initial load
loadPersons();

function openStream() {
  window.open("/stream", "_blank");
}

function getFilterQS() {
  const s = document.getElementById('startDate').value;
  const e = document.getElementById('endDate').value;
  const params = new URLSearchParams();
  if (s) params.set('start', s);
  if (e) params.set('end', e);
  const qs = params.toString();
  return qs ? `?${qs}` : '';
}

function applyFilter() {
  loadEvents();
}

function exportCSV() {
  const qs = getFilterQS();
  // open in new tab to trigger download
  window.open(`/admin/events/export${qs}`, '_blank');
}

async function loadEvents() {
  const qs = getFilterQS();
  const res = await fetch(`/admin/events${qs}`);
  const data = await res.json();
  const table = document.getElementById("eventsTable");
  table.innerHTML = `
    <tr>
      <th>Time</th><th>Reason</th>
      <th>Auth</th><th>Restr</th><th>Unk</th><th>Snapshot</th>
    </tr>`;
  data.forEach(e => {
    const href = e.snapshot ? `/${e.snapshot}` : '#';
    table.innerHTML += `
      <tr>
        <td>${e.time}</td>
        <td>${e.reason}</td>
        <td>${e.authorized}</td>
        <td>${e.restricted}</td>
        <td>${e.unknown}</td>
        <td>${e.snapshot ? `<a href="${href}" target="_blank">View</a>` : '-'}</td>
      </tr>`;
  });
}

// WebSocket alerts (same as /events page, with banner update)
(function setupAlertsWS() {
  const scheme = location.protocol === 'https:' ? 'wss' : 'ws';
  const ws = new WebSocket(`${scheme}://${location.host}/ws/alerts`);
  const banner = document.getElementById('alertBanner');
  const text = document.getElementById('alertText');

  ws.onopen = () => {
    ws.send('hello');
    setInterval(() => {
      if (ws.readyState === WebSocket.OPEN) ws.send('ping');
    }, 30000);
  };

  ws.onmessage = (event) => {
    const data = JSON.parse(event.data);
    // Popup
    alert(
      "ðŸš¨ SECURITY ALERT\n" +
      data.reason + "\n" +
      "Authorized: " + data.authorized + ", " +
      "Restricted: " + data.restricted + ", " +
      "Unknown: " + data.unknown
    );
    // Banner
    text.textContent = `${data.reason} â€” Auth:${data.authorized} Restr:${data.restricted} Unk:${data.unknown}`;
    banner.style.display = 'block';
  };

  ws.onclose = () => console.log('ws closed');
  ws.onerror = (e) => console.error('ws error', e);
})();

loadPersons();
loadEvents();
</script>

<style>
.toast {
  margin: 10px 0 14px;
  padding: 10px 12px;
  border-radius: 10px;
  color: #e5e7eb;
}
</style>

</body>
</html>
